# Руководство по интеграции Telegram бота

## Обзор

Проект успешно интегрирован с Telegram Bot API с поддержкой:
- Множественных ботов
- Всех типов медиа-сообщений (фото, видео, аудио, голосовые, документы, стикеры, GIF)
- Двусторонней коммуникации (получение от пользователей и отправка от админов)
- Загрузки файлов и записи голосовых сообщений в веб-интерфейсе

## Шаги для запуска

### 1. Настройка базы данных

Выполните миграцию для добавления поддержки ботов:

```bash
cd backend
psql -U postgres -d telegram_admin -f src/migrations/002_add_bot_support.sql
```

Миграция:
- Создаст таблицу `bots`
- Добавит поле `bot_id` в таблицы `chats` и `messages`
- Добавит поле `is_from_admin` в таблицу `messages`
- Создаст необходимые индексы

### 2. Настройка токена бота

Добавьте токен вашего Telegram бота в файл `.env`:

```bash
cd backend
cp .env.example .env
# Отредактируйте .env и добавьте:
TELEGRAM_BOT_TOKEN=8256177641:AAGcEIdVAZymqE_jiM9YaAGzVqlRHeiLZPM
```

### 3. Инициализация первого бота

После запуска сервера, первый бот будет автоматически инициализирован при старте приложения.

Или вы можете добавить бота через API:

```bash
curl -X POST http://localhost:3000/bots \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"token": "YOUR_BOT_TOKEN"}'
```

### 4. Запуск приложения

#### Backend:

```bash
cd backend
npm install
npm run build
npm start
```

#### Frontend:

```bash
npm install
npm run dev
```

## Архитектура

### Backend

#### Структура модулей:

```
backend/src/
├── telegram/
│   ├── telegram.module.ts       # Модуль Telegram
│   ├── telegram.service.ts      # Сервис для управления ботами
│   ├── telegram.controller.ts   # REST API для управления ботами
│   └── dto/
│       └── create-bot.dto.ts    # DTO для создания бота
├── entities/
│   ├── Bot.entity.ts            # Сущность бота
│   ├── Chat.entity.ts           # Обновлена: добавлен botId
│   ├── Message.entity.ts        # Обновлена: добавлен botId и isFromAdmin
│   └── ...
├── chats/
│   ├── chats.service.ts         # Обновлен: интеграция с TelegramService
│   └── chats.controller.ts      # Обновлен: поддержка загрузки файлов
└── migrations/
    └── 002_add_bot_support.sql  # Миграция для поддержки ботов
```

#### TelegramService

Основные методы:

- `initializeBots()` - Запуск всех активных ботов при старте
- `createBot(token)` - Создание и запуск нового бота
- `sendMessage(botId, chatId, text)` - Отправка текстового сообщения
- `sendPhoto/Video/Voice/Audio/Document/Animation()` - Отправка медиа

Обработчики входящих сообщений:
- `handleTextMessage()` - Текстовые сообщения
- `handlePhotoMessage()` - Фото
- `handleVideoMessage()` - Видео
- `handleVoiceMessage()` - Голосовые
- `handleDocumentMessage()` - Документы
- `handleAudioMessage()` - Аудио
- `handleStickerMessage()` - Стикеры
- `handleVideoNoteMessage()` - Видео-заметки
- `handleAnimationMessage()` - GIF анимации

#### Логика обработки входящих сообщений:

1. Получить или создать User по `telegramId`
2. Получить или создать Chat по `telegramChatId` и `botId`
3. Создать Message с правильным `messageType` и `fileId`
4. Обновить `lastMessage` и `lastMessageAt` в Chat

#### ChatsService

Обновленный метод `createMessage()`:
- Принимает файл через `Express.Multer.File`
- Определяет тип сообщения по MIME типу
- Отправляет сообщение через TelegramService
- Сохраняет сообщение в БД с флагом `isFromAdmin = true`

### Frontend

#### Обновленные компоненты:

**MessageItem.tsx**
- Рендеринг всех типов медиа-сообщений
- Поддержка изображений, видео, аудио, голосовых, документов, стикеров, GIF

**MessageInput.tsx**
- Кнопка для загрузки файлов
- Запись голосовых сообщений через Web API MediaRecorder
- Превью прикрепленных файлов перед отправкой
- Поддержка drag-and-drop (можно добавить)

**ChatsPage.tsx**
- Использование `sendMessageWithMedia()` для отправки сообщений с файлами
- Обработка медиа-типов при получении сообщений

**api.ts**
- Новый метод `sendMessageWithMedia()` с `multipart/form-data`
- Методы для работы с ботами: `getBots()`, `createBot()`, `deleteBot()`

## Типы сообщений

Поддерживаемые типы (enum MessageType):

- `TEXT` - Текстовые сообщения
- `PHOTO` - Фотографии
- `VIDEO` - Видео
- `VOICE` - Голосовые сообщения
- `DOCUMENT` - Документы
- `AUDIO` - Аудиофайлы
- `STICKER` - Стикеры
- `VIDEO_NOTE` - Видео-заметки (кружочки)
- `ANIMATION` - GIF анимации
- `LOCATION` - Геолокация (пока не реализовано)
- `CONTACT` - Контакты (пока не реализовано)

## API Endpoints

### Боты

```
GET    /bots           # Получить список ботов
POST   /bots           # Создать нового бота
GET    /bots/:id       # Получить информацию о боте
DELETE /bots/:id       # Удалить бота
```

### Чаты и сообщения

```
GET    /chats                    # Получить список чатов
GET    /chats/:id/messages       # Получить сообщения чата
POST   /chats/:id/messages       # Отправить сообщение (с файлом или без)
POST   /chats/:id/delete         # Удалить чат
```

## Использование file_id

Для отправки медиа используется подход с `file_id`:
- При получении медиа от пользователя сохраняется `fileId` из Telegram
- Для отображения медиа в интерфейсе используется либо `fileUrl` (если доступен), либо Telegram File API
- При отправке можно использовать как загруженный файл, так и существующий `fileId`

## Безопасность

1. Все endpoints защищены JWT аутентификацией (`JwtAuthGuard`)
2. Токены ботов хранятся в базе данных
3. Файлы загружаются в память и отправляются напрямую в Telegram (не сохраняются на диске)
4. Используется multer для безопасной загрузки файлов

## Ограничения и будущие улучшения

1. **Медиа-файлы**: Файлы не сохраняются на сервере, используются file_id из Telegram
2. **Polling mode**: Используется long polling вместо webhook (проще для разработки)
3. **WebSocket**: Можно добавить для real-time обновлений без перезагрузки
4. **Уведомления**: Можно добавить push-уведомления для новых сообщений
5. **Множественные админы**: Сейчас все админы пишут от имени бота
6. **Геолокация и контакты**: Типы определены, но обработка не реализована

## Тестирование

### Тест получения сообщений от пользователя:

1. Найдите вашего бота в Telegram по username
2. Отправьте текстовое сообщение
3. Отправьте фото, видео, голосовое
4. Проверьте, что они появились в интерфейсе админ-панели

### Тест отправки сообщений от админа:

1. Откройте чат в админ-панели
2. Напишите текстовое сообщение
3. Прикрепите файл (фото/видео/документ)
4. Запишите голосовое сообщение
5. Проверьте, что сообщения пришли пользователю в Telegram

## Troubleshooting

### Бот не запускается

Проверьте:
- Правильность токена в .env
- Что таблица `bots` создана в БД
- Логи сервера: `backend/backend.log`

### Сообщения не отправляются

Проверьте:
- JWT токен валиден
- Chat существует в БД и связан с ботом
- Бот имеет доступ к чату (пользователь не заблокировал бота)

### Медиа не отображается

Проверьте:
- `fileId` сохранен в БД
- У бота есть права на доступ к файлам Telegram
- CORS настроен правильно для загрузки файлов

## Заключение

Интеграция завершена и готова к использованию. Все основные функции реализованы:
✅ Множественные боты
✅ Получение всех типов сообщений от пользователей
✅ Отправка всех типов сообщений от админов
✅ Загрузка файлов и запись голосовых в веб-интерфейсе
✅ Отображение медиа в чате

